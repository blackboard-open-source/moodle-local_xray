define ("local_xray/toggle_categories",["jquery","core/str","core/ajax","core/templates"],function(a,b,c,d){return{init:function init(b){var e=this,f="#cat_",g="#id_courses_",h="joined_courses",i=JSON.parse(b);e.lang_strs=i.lang_strs;e.www_root=i.www_root;e.formIsValid=!0;e.selection=[];e.rootcat={id:0};e.init=function(){e.loadCategory(e.rootcat,e.initExpandCollapseButtons);e.loadSelection()};e.loadSelection=function(){var b=a("[name="+h+"]").val();if(b&&""!==b){e.selection=b.split(",")}};e.initExpandCollapseButtons=function(){a("#xrayexpandallbtn").on("click",function(a){a.preventDefault();e.expandAllCategories(function(){})});a("#xraycollapseallbtn").on("click",function(a){a.preventDefault();e.recurseCategoryCollapse(e.rootcat)})};e.expandAllCategories=function(b){var c=a("#xrayexpandallbtn"),d=a("#xraycollapseallbtn");c.append("<span class=\"xray_validate_loader\"></span>");c.prop("disabled",!0);d.prop("disabled",!0);e.recurseCategoryExpand(e.rootcat,function(){c.children(".xray_validate_loader").remove();c.prop("disabled",!1);d.prop("disabled",!1);b()})};e.recurseCategoryExpand=function(b,c){e.toggleCategoryUI(b,!1);e.loadCategory(b,function(){if(!b.categories&&!b.courses){return}var d=a(f+b.id+"_li");if(d.hasClass("xray-collapsible-list-closed")){d.click();e.toggleCategoryUI(b,!1)}if(!b.categories||0===b.categories.length){e.toggleCategoryUI(b,!0);c()}else{e.recurseCategoriesExpand(0,b.categories,function(){e.toggleCategoryUI(b,!0);c()})}})};e.recurseCategoriesExpand=function(a,b,c){if(a<b.length){e.recurseCategoryExpand(b[a],function(){e.recurseCategoriesExpand(a+1,b,c)})}else{c()}};e.recurseCategoryCollapse=function(b){if(!b.categories&&!b.courses){return}var d=a(f+b.id+"_li");if(d.hasClass("xray-collapsible-list-open")){d.click()}if(!b.categories){return}for(var g in b.categories){e.recurseCategoryCollapse(b.categories[g])}};e.createCategoryListeners=function(a){if(!a){return}for(var b in a){e.createListenersInCategory(a[b])}};e.addMyListenerToCategories=function(b){if(b.categories&&b.myListener){for(var d in b.categories){a(f+b.categories[d].id).change(b.myListener);b.categories[d].parentListener=b.myListener}}};e.addMyListenerToCourses=function(a){if(a.courses&&a.myListener){for(var b in a.courses){e.addMyListenerToCourse(a,a.courses[b])}}};e.addMyListenerToCourse=function(b,c){a(g+c.id).change(function(){var d=a(this).is(":checked");e.updateCourseSelection(c,d);b.myListener()})};e.addClickListenersToCategories=function(a){if(!a){return}for(var b in a){e.addClickListenersToCategory(a[b])}};e.addClickListenersToCategory=function(b){a(f+b.id).on("click",function selectCategory(c){c.stopPropagation();var d=a(this);e.toggleCategoryUI(b,!1);e.checkCategory(b,d.prop("checked"),function(){e.toggleCategoryUI(b,!0)})});a(f+b.id+"_li").on("click",function expandCategory(a){a.stopPropagation();e.toggleCategoryUI(b,!1);e.loadCategory(b,function(){e.toggleCategoryUI(b,!0)})})};e.toggleCategoryUI=function(b,c){var d=a(f+b.id),g=a("#id_submitbutton"),h=a(f+b.id+"_lbl");d.prop("disabled",!c);g.prop("disabled",!c||!e.formIsValid);if(c){h.children(".xray_validate_loader").remove()}else{h.append("<span class=\"xray_validate_loader\"></span>")}};e.createListenersInCategory=function(b){b.myListener=function(){var c=e.atLeastOneCourseChecked(b.courses)&&e.areCoursesIndeterminate(b.courses);c=c||e.atLeastOneCourseChecked(b.courses)&&e.atLeastOneCourseUnChecked(b.courses);c=c||e.atLeastOneCatChecked(b.categories)&&e.areCatsIndeterminate(b.categories);if(b.courses&&b.categories){c=c||e.areCatsChecked(b.categories)&&!e.areCoursesChecked(b.courses);c=c||e.areCoursesChecked(b.courses)&&e.atLeastOneCatUnCheckedDisabled(b.categories)}var d=c||e.atLeastOneCatChecked(b.categories)||e.atLeastOneCourseChecked(b.courses),g=a(f+b.id);g.prop("checked",d);g.prop("indeterminate",c);if(b.parentListener){b.parentListener()}};b.myListener()};e.checkCategories=function(a,b,d){for(var f in a){e.toggleCategoryUI(a[f],!1)}e.recursiveCategoryCheck(0,a,b,d)};e.recursiveCategoryCheck=function(a,b,c,d){if(a<b.length){e.checkCategory(b[a],c,function(){e.recursiveCategoryCheck(a+1,b,c,d)})}else{d()}};e.checkCategory=function(b,c,d){var g=function(){e.toggleCategoryUI(b,!0);b.myListener();return d()},h=a(f+b.id);h.prop("checked",c);e.loadCategory(b,function checkMyStuff(){if(b.courses){e.checkCourses(b.courses,c)}if(b.categories){if(0<b.categories.length){e.checkCategories(b.categories,c,g)}else{g()}}else{g()}if(b.parentListener){b.parentListener()}})};e.checkCourses=function(b,d){for(var f in b){a(g+b[f].id).prop("checked",d);e.updateCourseSelection(b[f],d)}};e.areCatsChecked=function(b){if(!b){return!1}var d=!0;for(var e in b){d=d&&a(f+b[e].id).prop("checked")}return d};e.atLeastOneCatChecked=function(b){if(!b){return!1}var d=!1;for(var e in b){d=d||a(f+b[e].id).prop("checked");if(d){break}}return d};e.atLeastOneCatUnCheckedDisabled=function(b){if(!b){return!1}for(var d in b){if(!a(f+b[d].id).prop("checked")){return!0}}return!1};e.atLeastOneCourseUnChecked=function(b){if(!b){return!1}for(var d in b){if(!a(g+b[d].id).prop("checked")){return!0}}return!1};e.areCoursesChecked=function(b){if(!b||0===Object.keys(b).length){return!0}var d=!0;for(var e in b){d=d&&a(g+b[e].id).prop("checked")}return d};e.areCatsIndeterminate=function(b){if(!b){return!1}var d=0,e=0,g=Object.keys(b).length;for(var h in b){d+=a(f+b[h].id).prop("checked")?1:0;e+=a(f+b[h].id).prop("indeterminate")?1:0}return d<g||0<e};e.areCoursesIndeterminate=function(b){if(!b){return!1}var d=0,e=Object.keys(b).length;for(var f in b){d+=a(g+b[f].id).prop("checked")?1:0}return d<e};e.atLeastOneCourseChecked=function(b){if(!b){return!1}var d=!1;for(var e in b){d=d||a(g+b[e].id).prop("checked");if(d){break}}return d};e.updateCourseSelection=function(b,c){if(c){e.addCourseToSelection(b)}else{e.remCourseFromSelection(b)}a("[name="+h+"]").val(e.selection.join(","))};e.addCourseToSelection=function(a){if(-1===e.selection.indexOf(a.id)){e.selection.push(a.id)}};e.remCourseFromSelection=function(a){var b=e.selection.indexOf(a.id);while(-1<b){e.selection.splice(b,1);b=e.selection.indexOf(a.id)}};e.getSelectedCourseIdx=function(a){var b=-1;for(var c in e.selection){if(e.selection[c].cid===a.cid){b=c;break}}return b};e.loadCategory=function(b,c){if(b.loaded){if(c){c()}return}b.loaded=!0;a.when(a.ajax({url:e.www_root+"/local/xray/view.php?controller=courseapi&action=listcategories&categoryid="+b.id,dataType:"json",success:function success(a){if(!a||0===a.length){return}b.categories=a},error:function error(){b.loaded=!1}}),a.ajax({url:e.www_root+"/local/xray/view.php?controller=courseapi&action=listcourses&categoryid="+b.id,dataType:"json",success:function success(a){if(!a||0===a.length){return}b.courses=a},error:function error(){b.loaded=!1}})).then(function(){if(!b.loaded){if(c){c()}return}e.emptyCat(b);var d=e.renderCategories(b,b.categories);a.when(d).then(function(){var d=e.renderCourses(b,b.courses);a.when(d).then(function(){e.createCategoryListeners(b.categories);e.addClickListenersToCategories(b.categories);e.addMyListenerToCategories(b);e.addMyListenerToCourses(b);e.applyStatusToCategories(b.categories);if(c){c()}})})})};e.emptyCat=function(b){a(f+b.id+"_children").empty()};e.renderCategories=function(b,d){if(!d){return}var f=[],g=a.Deferred();for(var h in d){var c=e.renderCategory(b,d[h]);f.push(c)}a.when.apply(a,f).then(function(){CollapsibleLists.applyTo(document.getElementById("cat_"+b.id+"_children"));g.resolve()});return g};e.renderCategory=function(b,c){var g=a.Deferred(),h=e.rootcat.id==b.id?e.lang_strs.xraycategory:e.lang_strs.xraysubcategory,i={categoryid:c.id,categoryname:c.name,categorytree:h};d.render("local_xray/render_category",i).done(function(c){a(f+b.id+"_children").append(c);g.resolve()});return g};e.applyStatusToCategories=function(a){if(!a){return}for(var b in a){e.applyStatusToCategory(a[b])}};e.applyStatusToCategory=function(b){a(f+b.id).prop("indeterminate",b.indeterminate);a(f+b.id).prop("checked",b.checked)};e.renderCourses=function(b,d){if(!d){return}var f=[],g=a.Deferred();for(var h in d){var c=e.renderCourse(b,d[h]);f.push(c)}a.when.apply(a,f).then(function(){g.resolve()});return g};e.renderCourse=function(b,c){var g=a.Deferred(),h=e.www_root+"/course/view.php?id="+c.id,i=e.lang_strs.xraycourse,j=c.checked?"checked=\"checked\" ":" ",k={courseid:c.id,coursename:c.name,courseshortname:c.shortname,courselink:h,courselabel:i,coursechecked:j};d.render("local_xray/render_course",k).done(function(c){a(f+b.id+"_children").append(c);g.resolve()});return g};a(document).ready(function(){e.init()})}}});
//# sourceMappingURL=toggle_categories.min.js.map
