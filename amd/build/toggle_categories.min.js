define(["jquery","core/str","core/ajax","core/templates"],function(a,b,c,d){return{init:function(b){var c=this,e="#cat_",f="#id_courses_",g="joined_courses",h="#id_submitbutton",i=JSON.parse(b);c.lang_strs=i.lang_strs,c.www_root=i.www_root,c.formIsValid=!0,c.selection=[],c.rootcat={id:0},c.init=function(){c.loadCategory(c.rootcat,c.initExpandCollapseButtons),c.loadSelection()},c.loadSelection=function(){var b=a("[name="+g+"]").val();b&&""!==b&&(c.selection=b.split(","))},c.initExpandCollapseButtons=function(){a("#xrayexpandallbtn").on("click",function(a){a.preventDefault(),c.expandAllCategories(function(){})}),a("#xraycollapseallbtn").on("click",function(a){a.preventDefault(),c.recurseCategoryCollapse(c.rootcat)})},c.expandAllCategories=function(b){var d=a("#xrayexpandallbtn"),e=a("#xraycollapseallbtn");d.append('<span class="xray_validate_loader"></span>'),d.prop("disabled",!0),e.prop("disabled",!0),c.recurseCategoryExpand(c.rootcat,function(){d.children(".xray_validate_loader").remove(),d.prop("disabled",!1),e.prop("disabled",!1),b()})},c.recurseCategoryExpand=function(b,d){c.toggleCategoryUI(b,!1),c.loadCategory(b,function(){if(b.categories||b.courses){var f=a(e+b.id+"_li");f.hasClass("xray-collapsible-list-closed")&&(f.click(),c.toggleCategoryUI(b,!1)),b.categories&&0!==b.categories.length?c.recurseCategoriesExpand(0,b.categories,function(){c.toggleCategoryUI(b,!0),d()}):(c.toggleCategoryUI(b,!0),d())}})},c.recurseCategoriesExpand=function(a,b,d){if(a<b.length){var e=a+1;c.recurseCategoryExpand(b[a],function(){c.recurseCategoriesExpand(e,b,d)})}else d()},c.recurseCategoryCollapse=function(b){if(b.categories||b.courses){var d=a(e+b.id+"_li");if(d.hasClass("xray-collapsible-list-open")&&d.click(),b.categories)for(var f in b.categories)c.recurseCategoryCollapse(b.categories[f])}},c.createCategoryListeners=function(a){if(a)for(var b in a)c.createListenersInCategory(a[b])},c.addMyListenerToCategories=function(b){if(b.categories&&b.myListener)for(var c in b.categories)a(e+b.categories[c].id).change(b.myListener),b.categories[c].parentListener=b.myListener},c.addMyListenerToCourses=function(a){if(a.courses&&a.myListener)for(var b in a.courses)c.addMyListenerToCourse(a,a.courses[b])},c.addMyListenerToCourse=function(b,d){a(f+d.id).change(function(){var e=a(this).is(":checked");c.updateCourseSelection(d,e),b.myListener()})},c.addClickListenersToCategories=function(a){if(a)for(var b in a)c.addClickListenersToCategory(a[b])},c.addClickListenersToCategory=function(b){var d=function(d){d.stopPropagation();var e=a(this);c.toggleCategoryUI(b,!1),c.checkCategory(b,e.prop("checked"),function(){c.toggleCategoryUI(b,!0)})},f=function(a){a.stopPropagation(),c.toggleCategoryUI(b,!1),c.loadCategory(b,function(){c.toggleCategoryUI(b,!0)})};a(e+b.id).on("click",d),a(e+b.id+"_li").on("click",f)},c.toggleCategoryUI=function(b,d){var f=a(e+b.id),g=a(h),i=a(e+b.id+"_lbl"),j="disabled";f.prop(j,!d),g.prop(j,!d||!c.formIsValid),d?i.children(".xray_validate_loader").remove():i.append('<span class="xray_validate_loader"></span>')},c.createListenersInCategory=function(b){b.myListener=function(){var d=c.atLeastOneCourseChecked(b.courses)&&c.areCoursesIndeterminate(b.courses);d=d||c.atLeastOneCourseChecked(b.courses)&&c.atLeastOneCourseUnChecked(b.courses),d=d||c.atLeastOneCatChecked(b.categories)&&c.areCatsIndeterminate(b.categories),b.courses&&b.categories&&(d=d||c.areCatsChecked(b.categories)&&!c.areCoursesChecked(b.courses),d=d||c.areCoursesChecked(b.courses)&&c.atLeastOneCatUnCheckedDisabled(b.categories));var f=d||c.atLeastOneCatChecked(b.categories)||c.atLeastOneCourseChecked(b.courses),g=a(e+b.id);g.prop("checked",f),g.prop("indeterminate",d),b.parentListener&&b.parentListener()},b.myListener()},c.checkCategories=function(a,b,d){for(var e in a)c.toggleCategoryUI(a[e],!1);c.recursiveCategoryCheck(0,a,b,d)},c.recursiveCategoryCheck=function(a,b,d,e){if(a<b.length){var f=a+1;c.checkCategory(b[a],d,function(){c.recursiveCategoryCheck(f,b,d,e)})}else e()},c.checkCategory=function(b,d,f){var g=function(){return c.toggleCategoryUI(b,!0),b.myListener(),f()},h=a(e+b.id);h.prop("checked",d);var i=function(){b.courses&&c.checkCourses(b.courses,d),b.categories&&b.categories.length>0?c.checkCategories(b.categories,d,g):g(),b.parentListener&&b.parentListener()};c.loadCategory(b,i)},c.checkCourses=function(b,d){for(var e in b)a(f+b[e].id).prop("checked",d),c.updateCourseSelection(b[e],d)},c.areCatsChecked=function(b){if(!b)return!1;var c=!0;for(var d in b)c=c&&a(e+b[d].id).prop("checked");return c},c.atLeastOneCatChecked=function(b){if(!b)return!1;var c=!1;for(var d in b)if(c=c||a(e+b[d].id).prop("checked"))break;return c},c.atLeastOneCatUnCheckedDisabled=function(b){if(!b)return!1;for(var c in b)if(!a(e+b[c].id).prop("checked"))return!0;return!1},c.atLeastOneCourseUnChecked=function(b){if(!b)return!1;for(var c in b)if(!a(f+b[c].id).prop("checked"))return!0;return!1},c.areCoursesChecked=function(b){if(!b||0===Object.keys(b).length)return!0;var c=!0;for(var d in b)c=c&&a(f+b[d].id).prop("checked");return c},c.areCatsIndeterminate=function(b){if(!b)return!1;var c=0,d=0,f=Object.keys(b).length;for(var g in b)c+=a(e+b[g].id).prop("checked")?1:0,d+=a(e+b[g].id).prop("indeterminate")?1:0;return c<f||d>0},c.areCoursesIndeterminate=function(b){if(!b)return!1;var c=0,d=Object.keys(b).length;for(var e in b)c+=a(f+b[e].id).prop("checked")?1:0;return c<d},c.atLeastOneCourseChecked=function(b){if(!b)return!1;var c=!1;for(var d in b)if(c=c||a(f+b[d].id).prop("checked"))break;return c},c.updateCourseSelection=function(b,d){d?c.addCourseToSelection(b):c.remCourseFromSelection(b),a("[name="+g+"]").val(c.selection.join(","))},c.addCourseToSelection=function(a){c.selection.indexOf(a.id)===-1&&c.selection.push(a.id)},c.remCourseFromSelection=function(a){for(var b=c.selection.indexOf(a.id);b>-1;)c.selection.splice(b,1),b=c.selection.indexOf(a.id)},c.getSelectedCourseIdx=function(a){var b=-1;for(var d in c.selection)if(c.selection[d].cid===a.cid){b=d;break}return b},c.loadCategory=function(b,d){return b.loaded?void(d&&d()):(b.loaded=!0,void a.when(a.ajax({url:c.www_root+"/local/xray/view.php?controller=courseapi&action=listcategories&categoryid="+b.id,dataType:"json",success:function(a){a&&0!==a.length&&(b.categories=a)},error:function(){b.loaded=!1}}),a.ajax({url:c.www_root+"/local/xray/view.php?controller=courseapi&action=listcourses&categoryid="+b.id,dataType:"json",success:function(a){a&&0!==a.length&&(b.courses=a)},error:function(){b.loaded=!1}})).then(function(){if(!b.loaded)return void(d&&d());c.emptyCat(b);var e=c.renderCategories(b,b.categories);a.when(e).then(function(){var e=c.renderCourses(b,b.courses);a.when(e).then(function(){c.createCategoryListeners(b.categories),c.addClickListenersToCategories(b.categories),c.addMyListenerToCategories(b),c.addMyListenerToCourses(b),c.applyStatusToCategories(b.categories),d&&d()})})}))},c.emptyCat=function(b){a(e+b.id+"_children").empty()},c.renderCategories=function(b,d){if(d){var e=[],f=a.Deferred();for(var g in d){var h=c.renderCategory(b,d[g]);e.push(h)}return a.when.apply(a,e).then(function(){CollapsibleLists.applyTo(document.getElementById("cat_"+b.id+"_children")),f.resolve()}),f}},c.renderCategory=function(b,f){var g=a.Deferred(),h=c.rootcat.id==b.id?c.lang_strs.xraycategory:c.lang_strs.xraysubcategory,i={categoryid:f.id,categoryname:f.name,categorytree:h};return d.render("local_xray/render_category",i).done(function(c){a(e+b.id+"_children").append(c),g.resolve()}),g},c.applyStatusToCategories=function(a){if(a)for(var b in a)c.applyStatusToCategory(a[b])},c.applyStatusToCategory=function(b){a(e+b.id).prop("indeterminate",b.indeterminate),a(e+b.id).prop("checked",b.checked)},c.renderCourses=function(b,d){if(d){var e=[],f=a.Deferred();for(var g in d){var h=c.renderCourse(b,d[g]);e.push(h)}return a.when.apply(a,e).then(function(){f.resolve()}),f}},c.renderCourse=function(b,f){var g=a.Deferred(),h=c.www_root+"/course/view.php?id="+f.id,i=c.lang_strs.xraycourse,j=f.checked?'checked="checked" ':" ",k={courseid:f.id,coursename:f.name,courseshortname:f.shortname,courselink:h,courselabel:i,coursechecked:j};return d.render("local_xray/render_course",k).done(function(c){a(e+b.id+"_children").append(c),g.resolve()}),g},a(document).ready(function(){c.init()})}}});